name: Emulator Tests (iOS & Android)

on:
  workflow_dispatch: {}
  push:
    branches: [ main ]

jobs:
  ios-emulator:
    name: iOS Simulator smoke test
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        working-directory: p2p-kids-marketplace
        run: npm ci --legacy-peer-deps

      - name: Prebuild iOS app (generate native project)
        working-directory: p2p-kids-marketplace
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          npx expo prebuild --platform ios --no-install

      - name: Install CocoaPods
        working-directory: p2p-kids-marketplace
        run: |
          cd ios && pod install --repo-update

      - name: Build for Simulator
        working-directory: p2p-kids-marketplace
        run: |
          cd ios
          # Use Xcode build for simulator (derivedData path to avoid conflicts)
          xcodebuild -workspace "$(ls | grep .xcworkspace)" -scheme "$(ls | grep .xcodeproj | sed 's/\.xcodeproj//')" -configuration Debug -sdk iphonesimulator -derivedDataPath build

      - name: Boot iPhone Simulator and install app
        working-directory: p2p-kids-marketplace
        run: |
          SIM_NAME="iPhone 14"
          xcrun simctl boot "$SIM_NAME" || true
          APP_PATH=$(ls ios/build/Build/Products/Debug-iphonesimulator/*.app | head -n1)
          if [ -z "$APP_PATH" ]; then echo "Simulator app not built"; exit 1; fi
          xcrun simctl install booted "$APP_PATH"
          # Verify package installed by checking the bundle container
          xcrun simctl get_app_container booted com.p2pkidsmarketplace.app || true
      - name: Run Detox E2E tests (iOS)
        working-directory: p2p-kids-marketplace
        env:
          CI: true
        run: |
          # detox will use detox.config.json and run tests
          npx detox test --configuration ios.sim.debug --cleanup

  android-emulator:
    name: Android Emulator smoke test
    runs-on: ubuntu-latest
    env:
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
    steps:
      - uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 11

      - name: Install Android tools
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 31
          target: google_apis
          arch: x86_64
          emulator-options: '-no-window -no-audio -no-boot-anim'

      - name: Install dependencies
        working-directory: p2p-kids-marketplace
        run: npm ci --legacy-peer-deps

      - name: Prebuild Android app
        working-directory: p2p-kids-marketplace
        run: npx expo prebuild --platform android --no-install

      - name: Build and install debug APK
        working-directory: p2p-kids-marketplace
        run: |
          cd android
          ./gradlew assembleDebug
          ./gradlew installDebug || true

      - name: Verify package installed on emulator
        run: |
          adb devices
          adb shell pm list packages | grep com.p2pkidsmarketplace.app || (adb logcat -d | tail -n 200 && exit 1)
      - name: Run Detox E2E tests (Android)
        working-directory: p2p-kids-marketplace
        env:
          CI: true
        run: |
          npx detox test --configuration android.emu.debug --cleanup
